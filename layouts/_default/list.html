{{ define "main" }}
{{/* Auto-jump to first child for regular sections (not news) */}}
{{ if and .IsSection (ne .Section "news") }}
  {{ $first := index (first 1 (.Pages.ByWeight)) 0 }}
  {{ if $first }}
    <meta http-equiv="refresh" content="0; url={{ $first.RelPermalink }}">
    <link rel="canonical" href="{{ $first.Permalink }}">
    <p>If you are not redirected, <a href="{{ $first.RelPermalink }}">continue to {{ $first.Title }}</a>.</p>
  {{ else }}
    <p>No pages in this section yet.</p>
  {{ end }}
{{ else }}
<div class="layout">
  <article>
    <h1>{{ .Title }}</h1>
    {{/* Render any intro content from _index.md with wikilink support */}}
    {{ $raw := .Content }}
    {{ $withText := `\[\[([^\]|#]+)\|([^\]]+)\]\]` }}
    {{ $content := replaceRE $withText (printf "[$1](/$2/)") $raw }}
    {{ $simple := `\[\[([^\]|#]+)\]\]` }}
    {{ $content = replaceRE $simple (printf "[$1](/$1/)") $content }}
    {{ $content | safeHTML }}

    {{/* Build the list of pages; for news, sort by date desc and show dates */}}
    {{ $pages := .Pages }}
    {{ if eq .Section "news" }}
      {{ $pages = $pages.ByDate.Reverse }}
    {{ else }}
      {{ $pages = $pages.ByWeight }}
    {{ end }}

    {{ $p := .Paginate $pages }}
    {{ if eq .Section "news" }}
      {{/* Feed links for news landing */}}
      {{ if .IsSection }}
        {{ with .OutputFormats.Get "RSS" }}
          <div class="feed-links">
            <a class="feed-link" href="{{ .Permalink }}">RSS</a>
          </div>
        {{ end }}
      {{ end }}
      <div class="news-list">
        {{ range $p.Pages }}
          <div class="news-card">
            <div class="news-meta">
              <time datetime="{{ .Date.Format "2006-01-02" }}">{{ .Date.Format "2006-01-02" }}</time>
            </div>
            <h3 class="news-title"><a href="{{ .RelPermalink }}">{{ .Title }}</a></h3>
          </div>
        {{ end }}
      </div>
      {{ if or $p.HasPrev $p.HasNext }}
        <nav class="pager" aria-label="News pagination" style="margin-top: .75rem;">
          {{ if $p.HasPrev }}
            <a class="pager-newer" href="{{ $p.Prev.URL }}">← Newer posts</a>
          {{ end }}
          {{ if and $p.HasPrev $p.HasNext }}
            <span class="sep" style="margin: 0 .5rem; color: #9aa1aa;">|</span>
          {{ end }}
          {{ if $p.HasNext }}
            <a class="pager-older" href="{{ $p.Next.URL }}">Older posts →</a>
          {{ end }}
        </nav>
      {{ end }}
    {{ else }}
      <ul>
        {{ range $p.Pages }}
          <li><a href="{{ .RelPermalink }}">{{ .Title }}</a></li>
        {{ end }}
      </ul>
    {{ end }}

    {{ with .Params.section_footer }}
      <div class="section-footer">
        {{ . | markdownify }}
      </div>
    {{ end }}
  </article>
  <aside class="right">
    {{ partial "sidebar-right.html" . }}
  </aside>
</div>
{{ end }}
{{ end }}
